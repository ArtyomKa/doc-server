name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0, 0.2.0-alpha.1)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  verify:
    name: Verify CI Prerequisites
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Run CI pipeline
        run: |
          make ci
          echo "âœ… All CI prerequisites passed"
          echo "- Linting: Black, isort, Ruff checks passed"
          echo "- Type checking: MyPy checks passed"
          echo "- Tests: pytest with >=85% coverage passed"

  build:
    name: Build Distribution
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Build wheel and sdist
        run: make build

      - name: Check distribution files
        run: |
          ls -la dist/
          if [ ! -f dist/*.whl ]; then
            echo "âŒ Wheel file not found"
            exit 1
          fi
          if [ ! -f dist/*.tar.gz ]; then
            echo "âŒ Source distribution not found"
            exit 1
          fi
          echo "âœ… Distribution files created successfully"
          echo "Wheel: $(ls dist/*.whl)"
          echo "Source: $(ls dist/*.tar.gz)"
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distributions
          path: dist/
          retention-days: 5

  test-install:
    name: Smoke Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: distributions
          path: dist/

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Create virtual environment
        run: make install

      - name: Install from wheel
        run: |
          source .venv/bin/activate
          pip install dist/*.whl

      - name: Run smoke tests
        run: |
          source .venv/bin/activate
          
          echo "ðŸ§ª Testing version command..."
          VERSION_OUTPUT=$(doc-server --version)
          echo "Version: $VERSION_OUTPUT"
          if echo "$VERSION_OUTPUT" | grep -qE 'doc-server\s+[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "âœ… Version command works"
          else
            echo "âŒ Version command failed"
            exit 1
          fi
          
          echo "ðŸ§ª Testing help command..."
          doc-server --help || exit 1
          echo "âœ… Help command works"
          
          echo "ðŸ§ª Testing list command..."
          doc-server list --format simple || exit 1
          echo "âœ… List command works"
          
          echo "ðŸ§ª Testing health command..."
          doc-server health || true  # May fail without setup but should not crash
          echo "âœ… Health command works"
          
          echo "ðŸ§ª Testing search command (should fail gracefully without libraries)..."
          doc-server search --query "test" --library-id "/nonexistent" 2>&1 || true
          echo "âœ… Search command error handling works"
          
          echo "ðŸ§ª Testing ingest command help..."
          doc-server ingest --help || exit 1
          echo "âœ… Ingest command help works"
          
          echo "ðŸ§ª Testing remove command help..."
          doc-server remove --help || exit 1
          echo "âœ… Remove command help works"
          
          echo "âœ… All smoke tests passed!"
        shell: bash

  release:
    name: Create GitHub Release
    needs: [verify, build, test-install]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: distributions
          path: dist/

      - name: Determine version and prerelease status
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if prerelease (contains alpha, beta, or rc)
          if [[ "$VERSION" =~ -(alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Pre-release version detected: $VERSION"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Stable release version: $VERSION"
          fi
        shell: bash

      - name: Generate changelog from conventional commits
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: .github/changelog-config.json
          fromTag: ${{ github.event_name == 'push' && github.ref || '' }}
          toTag: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
            
            ## Installation
            
            ### From GitHub Release
            ```bash
            # Install wheel
            pip install doc-server-${{ steps.version.outputs.version }}-py3-none-any.whl
            
            # Or install from source
            pip install doc-server-${{ steps.version.outputs.version }}.tar.gz
            ```
            
            ## Quick Start
            
            ```bash
            # Check installation
            doc-server --version
            
            # List available commands
            doc-server --help
            
            # Start the MCP server
            doc-server serve
            ```
            
            ## Artifacts
            - **Wheel**: `doc-server-${{ steps.version.outputs.version }}-py3-none-any.whl`
            - **Source Distribution**: `doc-server-${{ steps.version.outputs.version }}.tar.gz`
          files: |
            dist/*.whl
            dist/*.tar.gz
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release v${{ steps.version.outputs.version }} created successfully!"
          echo "   Type: ${{ steps.version.outputs.prerelease == 'true' && 'Pre-release' || 'Stable' }}"
          echo "   Assets: Wheel and source distribution attached"
          echo "   Changelog: Generated from conventional commits"

  verify-release:
    name: Verify Release
    needs: release
    runs-on: ubuntu-latest
    if: always() && needs.release.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Create virtual environment
        run: make install

      - name: Verify release installation
        run: |
          source .venv/bin/activate
          
          VERSION="${{ needs.release.outputs.version }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"
          WHEEL_FILE="doc-server-${VERSION}-py3-none-any.whl"
          
          echo "Verifying release v${VERSION}..."
          echo "Release URL: ${RELEASE_URL}"
          
          # Download and install from release
          echo "ðŸ“¥ Downloading wheel from release..."
          curl -sL "${RELEASE_URL}/${WHEEL_FILE}" -o /tmp/${WHEEL_FILE} || {
            echo "âŒ Failed to download wheel"
            exit 1
          }
          
          echo "ðŸ“¦ Installing from release wheel..."
          pip install /tmp/${WHEEL_FILE} || {
            echo "âŒ Failed to install from release"
            exit 1
          }
          
          # Verify version
          echo "ðŸ” Verifying version..."
          INSTALLED_VERSION=$(doc-server --version)
          echo "Installed: ${INSTALLED_VERSION}"
          
          if echo "${INSTALLED_VERSION}" | grep -q "${VERSION}"; then
            echo "âœ… Version matches: ${VERSION}"
          else
            echo "âŒ Version mismatch. Expected: ${VERSION}, Got: ${INSTALLED_VERSION}"
            exit 1
          fi
          
          # Test basic functionality
          echo "ðŸ§ª Testing CLI commands..."
          doc-server --help > /dev/null || exit 1
          doc-server list --format simple > /dev/null || exit 1
          
          echo "âœ… Release verification successful!"
          echo "   Release v${VERSION} is ready for use"
        shell: bash
